<script src="../storage.js"></script>

<script src="blockly_compressed.js"></script>
<script src="blocks_compressed.js"></script>
<script src="javascript_compressed.js"></script>
<script src="msg/js/en.js"></script>

<script src="p5js/p5.js"></script>
<script src="p5js/sketch.js"></script>

<div id="welcomeSplash" onMouseDown="this.style.display = 'none';">
  <img id="welcomeSplash-img" src="media/poster.png"/>
</div>

<div id="codeView">
  <pre id="codeView-pre">
    loading code...
  </pre>
  <button onMouseUp="document.getElementById('codeView').style.display='none';">CLOSE</button>
</div>

<div id="toolbar">
  <div id="toolbar-leftHalf">
    <a href="#">
      <img src="media/playbutton.png" height="32"
	   onMouseOver="this.src='media/playbutton_rollover.png';"
	   onMouseOut="this.src='media/playbutton.png';"
	   onMouseUp="runCode();" class="imageButton"/></a>
    
      <img src="media/stopbutton.png" height="32"
	   onMouseOver="this.src='media/stopbutton_rollover.png';"
	   onMouseOut="this.src='media/stopbutton.png';"
	   onMouseUp="stopCode();" class="imageButton"/></a>
    
    <a href="#">
      <img src="media/savebutton.png" height="32"
	   onMouseOver="this.src='media/savebutton_rollover.png';"
	   onMouseOut="this.src='media/savebutton.png';"
	   onMouseUp="BlocklyStorage.link();" class="imageButton"/></a>
    <a href="#">
      <img src="media/codebutton.png" height="32"
	   onMouseOver="this.src='media/codebutton_rollover.png';"
	   onMouseOut="this.src='media/codebutton.png';"
	   onMouseUp="viewCode();" class="imageButton"/></a>
    <a href="#">
      <img src="media/restorebutton.png" height="32"
	   onMouseOver="this.src='media/restorebutton_rollover.png';"
	   onMouseOut="this.src='media/restorebutton.png';"
	   onMouseUp="BlocklyStorage.restoreBlocks();" class="imageButton"/></a>
  </div>
  <div id="toolbar-rightHalf">
    <a href="https://github.com/jtnimoy/rigglin/wiki" id="titleButton">
      <img src="media/title.png" height="32"
	   onMouseOver="this.src='media/title_rollover.png';"
	   onMouseOut="this.src='media/title.png';"
	   onMouseUp="" class="imageButton"/></a>
  </div>
  
  
</div>

<div id="workArea">
  <div id="blocklyDiv" style="position: absolute"></div>
  <div id="blocklyArea" style=""></div>
</div>

<xml id="toolbox" style="display: none">
  
  <category name="Color" colour="220">
    <category name="Creating & Reading" colour="220">
      <block type="colour_picker"></block>
      <block type="p5_color"></block>
      <block type="p5_alpha"></block>
      <block type="p5_blue"></block>
      <block type="p5_brightness"></block>
      <block type="p5_green"></block>
      <block type="p5_hue"></block>
      <block type="p5_lerpcolor"></block>
      <block type="p5_lightness"></block>
      <block type="p5_red"></block>
      <block type="p5_saturation"></block>
      
      
      <!--block type="colour_random"></block>
      <block type="colour_rgb"></block>
      <block type="colour_blend"></block-->
      
    </category>
    <category name="Setting" colour="220">
      <block type="p5_background"></block>
      <block type="p5_clear"></block>
      <block type="p5_colormode"></block>
      <block type="p5_stroke"></block>
      <block type="p5_fill"></block>
      <block type="p5_nostroke"></block>
      <block type="p5_nofill"></block>
    </category>
    <category name="p5.Color">
      <block type="p5_color"></block>
      <block type="p5_color_tostring"></block>
      <block type="p5_color_set"></block>
      
    </category>
  </category>

  <category name="DOM" colour="220">
    <block type="p5_createCanvas"></block>
  </category>
	
  
  <category name="Math" colour="220">
    <block type="p5_dist"></block>
    <block type="math_number">
      <field name="NUM">0</field>
    </block>
    <block type="math_number">
      <field name="NUM">42</field>
    </block>
    <block type="math_arithmetic"></block>
    <block type="math_single"></block>
    <block type="math_trig"></block>
    <block type="math_constant"></block>
    <block type="math_number_property"></block>
    <block type="math_change"></block>
    <block type="math_round"></block>
    <block type="math_on_list"></block>
    <block type="math_modulo"></block>
    <block type="math_constrain"></block>
    <block type="math_random_int"></block>
    <block type="math_random_float"></block>
    <block type="math_atan2"></block>
    
    <category name="p5.Vector" colour="220">
      <block type="p5_wantspvector"></block>
      <block type="p5_createvector"></block>
      <block type="p5_vector_get"></block>
    </category>
    
    
  </category>
  
  <category name="Procedures">
    <block type="procedures_defnoreturn"></block>
    <block type="procedures_defreturn"></block>
    <block type="procedures_mutatorcontainer"></block>
    <block type="procedures_mutatorarg"></block>
    <block type="procedures_callnoreturn"></block>
    <block type="procedures_callreturn"></block>
    <block type="procedures_ifreturn"></block>
  </category>
  
  <category name="Environment" colour="220">
    <block type="text_print"></block>
    <block type="p5_frameCount"></block>
    
    <block type="p5_width"></block>
    <block type="p5_height"></block>
    <block type="p5_mouseX"></block>
    <block type="p5_mouseY"></block>
    <block type="p5_pmouseX"></block>
    <block type="p5_pmouseY"></block>  
  </category>
  
  
  <category name="Shape">
    <category name="2D Primitives">
      <block type="p5_point"></block>
      <block type="p5_line"></block>
      <block type="p5_rect"></block>
      <block type="p5_quad"></block>
      <block type="p5_circle"></block>
      <block type="p5_ellipse"></block>
      <block type="p5_arc"></block>
      <block type="p5_square"></block>
      <block type="p5_triangle"></block>
      
    </category>
    
  </category>
  
  <category name="Structure" colour="220">
    <block type="p5_setup"></block>
    <block type="p5_draw"></block>
  </category>
  
  <category name="Typography" colour="220">

    <category name="Attributes" colour="220">  
      <block type="p5_textalign"></block>
      <block type="p5_textleading"></block>
      <block type="p5_textsize"></block>
      <block type="p5_set_textstyle"></block>
      <block type="p5_get_textwidth"></block>
      <block type="p5_textascent"></block>
      <block type="p5_textdescent"></block>
    </category>
    
    <category name="Loading & Displaying" colour="220">
      <block type="p5_loadfont"></block>
      <block type="p5_text"></block>
      <block type="p5_textfont"></block>
    </category>
    
    <category name="p5.Font" colour="220">
      <block type="p5_font_textbounds"></block>
      <block type="p5_font_texttopoints"></block>
    </category>
    
  </category>
  
  <category name="String" colour="121">
    <block type="text_print"></block>
    <block type="text"></block>
    <block type="text_join"></block>
    <block type="text_append"></block>
    <block type="text_length"></block>
    <block type="text_isEmpty"></block>
    <block type="text_indexOf"></block>
    <block type="text_charAt"></block>
    <block type="text_getSubstring"></block>
    <block type="text_changeCase"></block>
    <block type="text_trim"></block>
    <block type="text_prompt_ext"></block>
    <block type="text_prompt"></block>
    <block type="text_count"></block>
    <block type="text_replace"></block>
    <block type="text_reverse"></block>
  </category>
  
  <category name="Variables" colour="123">
    <block type="variables_get_dynamic"></block>
    <block type="variables_set_dynamic"></block>
  </category>
  <category name="Lists" colour="123">
    <block type="lists_create_empty"></block>
    <block type="lists_repeat"></block>
    <block type="lists_reverse"></block>
    <block type="lists_isEmpty"></block>
    <block type="lists_length"></block>
  </category>
  <category name="Controls" colour="121">
    <block type="controls_if"></block>
    <block type="controls_ifelse"></block>
    <block type="controls_whileUntil"></block>
    <block type="controls_repeat_ext"></block>
    <block type="controls_repeat"></block>
    <block type="controls_for"></block>
    <block type="controls_forEach"></block>
    <block type="controls_flow_statements"></block>
  </category>
  
  <category name="Logic" colour="121">
    <block type="logic_compare"></block>
    <block type="logic_operation"></block>
    <block type="logic_negate"></block>
    <block type="logic_boolean"></block>
    <block type="logic_null"></block>
    <block type="logic_ternary"></block>
  </category>
  



</xml>
<style>

  #welcomeSplash{
      position: absolute;
      margin-left: -197px;
      margin-top: -225px;
      left: 50%;
      top: 50%;
      z-index: 1000;
      filter: drop-shadow(10px 10px 4px rgba(0,0,0,0.3));
  }


  #codeView-pre{
      background: white;
      padding: 10px;
      height: 300px;
      
  }

  
  #codeView{
      display: none;
      position: absolute;
      background: white;
      margin-left: -400px;
      margin-top: -200px;
      left: 50%;
      top: 50%;
      width: 800px;
      height: 400px;
      z-index: 1000;
      filter: drop-shadow(10px 10px 4px rgba(0,0,0,0.3));
      padding: 10px;
      
  }


  
  #welcomeSplash-img{
      border-radius: 10px;
      width: 394px;
      height: 352px: 
  }
  
  /* hide the first p5 */
  #defaultCanvas0{
      display: none;
  }
  
  #workArea{
      display: inline-block;
  }
  
  .p5Canvas {
      vertical-align: top;
  }
  
  #toolbar{
      background: url('media/p5masthead-2.png');
      width:100%;
      text-align: left;
      display: inline-block;
      margin: 0;
      padding: 0;
  }

  
  #toolbar-leftHalf{
      width:49%;
      text-align: left;
      display: inline-block;
      margin: 0;
      padding: 0;
  }

  #toolbar-rightHalf{
      width:50%;
      text-align: right;
      display: inline-block;
      margin: 0;
      padding: 0;
  }

  
  
  .imageButton{
      margin: 10px 5px 10px 5px;
  }

  body{
      margin: 0;
      background: #ddd;
  }
</style>
<script>

  
  var blocklyArea = document.getElementById('blocklyArea');
  var blocklyDiv = document.getElementById('blocklyDiv');
  var workspace = Blockly.inject(blocklyDiv,
				 {
				     collapse: true,
				     scrollbars: false,
				     toolbox: document.getElementById('toolbox'),
				     grid: {
					 spacing: 20,
					 length: 3,
					 colour: '#ddd',
					 snap: true
				     },
				     trashcan: false,
				     zoom:
				     {controls: true,
				      wheel: true,
				      startScale: 1.0,
				      maxScale: 3,
				      minScale: 0.3,
				      scaleSpeed: 1.2}
				 });

  //blockly storage
  BlocklyStorage.HTTPREQUEST_ERROR = 'There was a problem with the request.\n';
  BlocklyStorage.LINK_ALERT = 'Share your blocks with this link:\n\n%1';
  BlocklyStorage.HASH_ERROR = 'Sorry, "%1" doesn\'t correspond with any saved Blockly file.';
  BlocklyStorage.XML_ERROR = 'Could not load your saved file.\n' +
    'Perhaps it was created with a different version of Blockly?';

  Blockly.HSV_SATURATION = 0.2; // 0 (inclusive) to 1 (exclusive), defaulting to 0.45
  Blockly.HSV_VALUE = 0.3; // 0 (inclusive) to 1 (exclusive), defaulting to 0.65

  
  BlocklyStorage.backupOnUnload();//use local storage

  
  //restore from cloud
  if ('BlocklyStorage' in window && window.location.hash.length > 1) {
      BlocklyStorage.retrieveXml(window.location.hash.substring(1));
  }

  
  
  //initial canvas dimensions
  var P5_WIDTH = 400;
  var P5_HEIGHT = 400;
  
  if(window.innerWidth < 900){ //elastic breakpoint
      P5_WIDTH = 100;
      P5_HEIGHT = 100;
  }
  

  //-------------------------------------

  function stopCode() {
      //HANDLER_DRAW = 0;
      P5.draw = function(){};
      console.log("stop");
  }

  //-------------------------------------

  function viewCode(){
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      var elm = document.getElementById("codeView");
      //toggle
      if(elm.style.display !== 'inline-block'){
	  elm.style.display = "inline-block";
      }else{
	  elm.style.display = "none";
      }
      var elmpre = document.getElementById("codeView-pre");
      elmpre.textContent = code;
  }
  
  function runCode() {
      console.log("run");
      // Generate JavaScript code and run it.
      window.LoopTrap = 10000;
      
      Blockly.JavaScript.INFINITE_LOOP_TRAP = '\
if (--window.LoopTrap == 0) \
      throw "Infinite loop.";\n\
';
      
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      P5_FRAMECOUNT = 0;
      try {
	  //console.log(code);
          eval(code);
      } catch (e) {
          alert(e);
      }
      //generate setup event
      P5.frameCount = 0;
      P5.setup();
  }

  
  var s = ( sketch ) => {
      
      //sketch.cmdQueue = [];
      
      sketch.preload = () => {
      }
      
      sketch.setup = () => {
	  sketch.createCanvas(P5_WIDTH,P5_HEIGHT);
	  sketch.background(255);
	  
	  sketch.setup = () => {};
      };
      
      sketch.draw = () => {

	  //process cmd queue. deprecated!
	  /* while(sketch.cmdQueue.length > 0){
	      let code = sketch.cmdQueue.shift();
	      try{
		  console.debug("p5.eval: "+code);
		  eval(code);
	      }catch(e){
		  console.debug(e);
		  console.debug(code);
	      }
	      }*/
      };

      //sketch.inject = (s) => {
      //sketch.cmdQueue.push(s);
  //};
      
  };
  
  var P5 = new p5(s);

    
  
  function onresize(e) {
      
      // Compute the absolute coordinates and dimensions of blocklyArea.
      var element = blocklyArea;
      element.style.height = window.innerHeight - 54;
      
      //extra 10 to ensure it will flow to the right
      element.style.width = window.innerWidth - (P5.width || P5_WIDTH) - 10;
      
      var x = 0;
      var y = 0;

      do {
	  x += element.offsetLeft;
	  y += element.offsetTop;
	  element = element.offsetParent;
      } while (element);

      // Position blocklyDiv over blocklyArea.
      blocklyDiv.style.left = x + 'px';
      blocklyDiv.style.top = y + 'px';
      blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
      blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
      Blockly.svgResize(workspace);
  };
  window.addEventListener('resize', onresize, false);
  onresize();
  Blockly.svgResize(workspace);


  
  //test
  //P5.inject("sketch.point(50,50);");

  //hide splash screen

  function hideSplash(){
      document.getElementById('welcomeSplash').style.display = 'none';
  };
  setTimeout("hideSplash()",2000)
  
</script>
